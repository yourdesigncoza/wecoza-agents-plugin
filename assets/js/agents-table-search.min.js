/**
 * Agents Table Search JavaScript for WeCoza Agents Plugin
 *
 * Implements real-time search functionality for the agents display table.
 * Searches across multiple agent fields (name, email, phone, city, etc.) with debouncing for performance.
 * Pagination is handled server-side through PHP.
 * 
 * @package WeCozaAgents
 * @since 1.0.0
 */

(function($){'use strict';const DEBUG_MODE=false;const SEARCH_CONFIG={debounceDelay:300,minSearchLength:0,searchInputSelector:'.search-input.search.form-control-sm',tableSelector:'#agents-display-data',tableRowSelector:'tbody tr',searchableColumns:[0,1,2,3,4,5,6,7]};let searchTimeout=null;let $searchInput=null;let $table=null;let $tableRows=null;let totalRows=0;let visibleRows=0;let filteredRows=[];let isInitialized=false;function agents_init_table_search(){if(isInitialized){if(DEBUG_MODE)console.log('WeCoza Agents: Already initialized, skipping duplicate initialization');return;}$searchInput=$(SEARCH_CONFIG.searchInputSelector);$table=$(SEARCH_CONFIG.tableSelector);$tableRows=$table.find(SEARCH_CONFIG.tableRowSelector);if($searchInput.length===0){if(DEBUG_MODE)console.warn('WeCoza Agents: Search input not found');return;}if($table.length===0){if(DEBUG_MODE)console.warn('WeCoza Agents: Table not found');return;}if($tableRows.length===0){if(DEBUG_MODE)console.warn('WeCoza Agents: No table rows found');return;}totalRows=$tableRows.length;visibleRows=totalRows;$searchInput.on('input keyup paste',function(){const searchTerm=$(this).val();agents_debounced_search(searchTerm);});$searchInput.closest('form').on('reset',function(){setTimeout(function(){agents_perform_search('');},10);});agents_add_search_status_indicator();totalRows=$tableRows.length;visibleRows=totalRows;isInitialized=true;if(DEBUG_MODE)console.log('WeCoza Agents: Table search and pagination initialized successfully');}function agents_debounced_search(searchTerm){if(searchTimeout){clearTimeout(searchTimeout);}searchTimeout=setTimeout(function(){agents_perform_search(searchTerm);},SEARCH_CONFIG.debounceDelay);}function agents_perform_search(searchTerm){const normalizedSearchTerm=searchTerm.toLowerCase().trim();let matchedRows=0;$tableRows.each(function(){const $row=$(this);const $cells=$row.find('td');if($cells.length===0){return;}let isMatch=true;if(normalizedSearchTerm.length>=SEARCH_CONFIG.minSearchLength){isMatch=agents_search_matches($cells,normalizedSearchTerm);}if(isMatch){$row.show();matchedRows++;}else{$row.hide();}});visibleRows=matchedRows;agents_update_search_status(searchTerm,visibleRows,totalRows);}function agents_search_matches($cells,searchTerm){for(let i=0;i<SEARCH_CONFIG.searchableColumns.length;i++){const columnIndex=SEARCH_CONFIG.searchableColumns[i];const $cell=$cells.eq(columnIndex);if($cell.length===0){continue;}const cellText=$cell.text().toLowerCase().trim();if(cellText.includes(searchTerm)){return true;}const cellParts=cellText.split(/[\s:,.-]+/).filter(part=>part.length>0);if(cellParts.some(part=>part.startsWith(searchTerm))){return true;}}return false;}function agents_add_search_status_indicator(){if($('#agents-search-status').length>0){return;}const $statusIndicator=$('<span>',{id:'agents-search-status',class:'badge badge-phoenix badge-phoenix-primary mb-2',style:'display: none;'});$table.before($statusIndicator);}function agents_update_search_status(searchTerm,visible,total){const $statusIndicator=$('#agents-search-status');if($statusIndicator.length===0){return;}if(searchTerm.trim().length===0){$statusIndicator.hide();return;}let statusText='';if(visible===0){statusText=`No agents found matching "${searchTerm}"`;}else if(visible===total){statusText=`Showing all ${total} agents`;}else{statusText=`Showing ${visible} of ${total} agents matching "${searchTerm}"`;}$statusIndicator.text(statusText).show();}function agents_reset_search(){if($searchInput){$searchInput.val('');agents_perform_search('');}}function agents_force_reinit(){isInitialized=false;agents_init_table_search();}function agents_get_search_stats(){return{totalRows:totalRows,visibleRows:visibleRows,searchTerm:$searchInput?$searchInput.val():'',isSearchActive:$searchInput?$searchInput.val().trim().length>0:false};}function exportClasses(){try{const table=document.querySelector('#agents-display-data');if(!table){console.error('Table not found for export');return;}const headers=[];const headerCells=table.querySelectorAll('thead th');headerCells.forEach(cell=>{const headerText=cell.textContent.trim();if(headerText&&headerText!=='Actions'){headers.push(headerText);}});const rows=[];const visibleRows=table.querySelectorAll('tbody tr:not([style*="display: none"])');visibleRows.forEach(row=>{const cells=row.querySelectorAll('td');const rowData=[];cells.forEach((cell,index)=>{if(index<cells.length-1){let cellText=cell.textContent.trim();cellText=cellText.replace(/\s+/g,' ');rowData.push(cellText);}});if(rowData.length>0){rows.push(rowData);}});if(rows.length===0){console.warn('No data to export');return;}let csvContent='';csvContent+=headers.map(header=>escapeCSVField(header)).join(',')+'\n';rows.forEach(row=>{csvContent+=row.map(field=>escapeCSVField(field)).join(',')+'\n';});const now=new Date();const timestamp=now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0')+String(now.getSeconds()).padStart(2,'0');const filename=`agents-export-${timestamp}.csv`;const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');if(link.download!==undefined){const url=URL.createObjectURL(blob);link.setAttribute('href',url);link.setAttribute('download',filename);link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);}else{navigator.msSaveBlob(blob,filename);}console.log(`Successfully exported ${rows.length} agent(s) to ${filename}`);}catch(error){console.error('Export error:',error);}}function escapeCSVField(field){if(field==null){return '';}const stringField=String(field).trim();if(stringField.includes(',')||stringField.includes('\n')||stringField.includes('"')){return '"'+stringField.replace(/"/g,'""')+'"';}return stringField;}window.exportClasses=exportClasses;window.WeCozaAgentsSearch={init:agents_init_table_search,reset:agents_reset_search,getStats:agents_get_search_stats,forceReinit:agents_force_reinit,export:exportClasses};$(document).ready(function(){setTimeout(function(){agents_init_table_search();},100);});})(jQuery);